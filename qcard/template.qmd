---
title: "基于肿瘤登记数据估计终生患癌风险"
subtitle: "使用R语言"
date: today
lang: zh
date-format: "YYYY年M月DD日"
authors:
  - name: '陈琼'
    affiliation: 河南省肿瘤医院
    email: chenq08@126.com
last-page: TRUE
execute: 
  eval: true
  echo: true
  warning: false
  message: false
categories:
  - 肿瘤登记
  - R语言
series: "肿瘤登记"
format:
  qcard-typst:
    fontsize: 20pt
    heading-size: 2em
    mainfont: "Noto Sans Osage"
    heading-family: "STHeiti"
    theme-color: blue
    number-sections: true
---

# 终生患癌风险概念
## 疾病风险

> 某一结局事件（疾病）在一个特定时间范围内的发生的概率或可能性^[风险、机会、概率或可能性]。

**为什么评估疾病风险？**

{{<v 1em>}}

 - 公共卫生行动决策需要
 - 合理分配公共卫生资源(时间和资金)
 
## 风险和关联

> 流行病学中的关联是指暴露与结局之间的相关性。

**关联的测量指标**

- 相对风险(Relative risk)
- 比值比(Odds ratio)
- 归因风险(Attributable risk)
- 人群归因风险(Population attributable risk)
- 人群归因风险百分比(Population attributable risk percent)

## 估计风险的数据来源

- 队列研究
- 病例对照研究
- 流行病学调查
- 从已经发表或发布的死亡率
- 现有的疾病登记系统


## 绝对风险 VS 相对风险

> **相对风险**(Relative risk, RR)，暴露组和对照组之间发生结局事件概率的比值，表示危险因素与结局事件的关联强度。

相对风险值通常以实际值展示，如**1.25**或**0.85**。

- RR > 1，表示暴露组风险高于对照组
- RR < 1，表示暴露组风险低于对照组

与非吸烟人群相比，吸烟人群的肺癌相对风险为1.25，表示吸烟人群的肺癌发生风险是非吸烟人群的1.25倍，或比非吸烟人群高25%。

## 绝对风险 VS 相对风险

> **绝对风险**(Absolute risk)，在特定的时期内特定人群发展为癌症的概率或可能性大小。

**终生患癌风险**是绝对风险的一种类型：

-  2020年，全球人群从出生到死亡的生命周期内被诊断为癌症的概率为25.10%，男性为26.27%，女性为23.98%^[Zheng RS, Wang SM, Zhang SW, et al. Global, regional, and national lifetime probabilities of developing cancer in 2020. [J] Sci Bull(Beijing). 2023;68(21):2620-2628.]。
- 每四个人中有一人（1 in 4）会在整个生命周期内被诊断为癌。

## 终生患癌风险

> **终生患癌风险**或**终生癌症死亡风险**特定人群在他们整个生命周期内被诊断为癌症或因癌症死亡的概率或可能性。

```{r}
#| label: tbl-risk1
#| tbl-cap: "美国男性和女性特定癌种终生患癌风险"
#| echo: false
library(flextable)
library(manuscript)
data <- tibble::tribble(
                        ~sites,  ~m1,  ~m2,  ~f1,  ~f2,
                  "全部", 41.6,   2L, 39.6,   3L,
                    "前列腺", 12.9,   8L,   NA,   NA,
           "肺癌",  6.3,  16L,  5.9,  17L,
            "结直肠癌",  4.3,  23L,  3.9,  25L,
  "膀胱癌(包括原位癌)",  3.6,  28L,  1.1,  89L,
       "皮肤黑色素瘤*",  3.6,  28L,  2.5,  41L,
                      "乳腺癌",  0.1, 726L,   13,   8L,
        "非霍奇金淋巴瘤",  2.4,  42L,  1.9,  52L,
     "肾和肾盂",  2.3,  43L,  1.4,  73L,
                    "淋巴瘤",  1.9,  53L,  1.3,  75L,
                    "胰腺癌",  1.7,  58L,  1.7,  60L,
         "肝癌",  1.5,  65L,  0.7, 143L
  )
header <- data.frame(
  col_keys = colnames(data),
  first =  c("部位", "男性", "男性", "女性", "女性"),
  second = c("部位", "%", "1 in", "%", "1 in"))
data |> flextable() |>
  set_header_df(mapping = header, key = "col_keys" ) |> 
  merge_h(part = "header") |> 
  merge_v(part = "header") |> 
  width(j = 1, width = 2) |> 
  width(j = c(2:5), width = 1.5) |> 
  align(align = "center", part = "all") |>
  theme_report() |> 
  line_spacing(space = 0.5)
```

{{<v 1em>}}

```{r}
#| echo: false
#| label: tbl-ltworld
#| tbl-cap: 全球居民终生癌症罹患风险^[Zheng RS, Wang SM, Zhang SW, et al. Global, regional, and national lifetime probabilities of developing cancer in 2020. [J] Sci Bull(Beijing). 2023;68(21):2620-2628.]
knitr::include_graphics("images/lt-world.png")
```

```{r}
#| echo: false
#| label: tbl-lthn
#| tbl-cap: 河南省居民终生癌症罹患风险和死亡风险^[Chen Q, Liu SZ, Liu Y, et al. Journal of National Cancer Center[J]. 2025,5(2)\:140-148]
#| out-height: "80%"
knitr::include_graphics("images/lt-henan.png")
```


## 终生患癌风险的度量指标

> 肿瘤登记是癌症负担数据的重要来源，基于登记处，通过定量评估患癌风险，可以为癌症负担描述提供一些新的视角。

1. 累积率/累积风险
1. 当前概率法- Current Probability (IARC scientific publication)
1. Devcan (SEER)
1. AMP method (Adjusted for Multiple Primary cancer)


## 累积率

$$
\text{累积率} = \sum_{i=1}^{A} w_i p_i
$$

- A 年龄组上限.
- $w_i$ 第 $i$ 个年龄组的组距
- $p_i$ 第$i$年龄组的年龄别率

1. 作为一种直接标准化发病率的形式，它可以立即用于不同人群之间的比较；
1. 可以直观地理解为个体在没有其他竞争风险情况下，到某一特定年龄患癌症的累积风险的近似值。

## 累积风险

> 累积率可以通过下面的公式转换为真实的累积风险。

$$ \text{累积风险} = 1 - e^{\text{-累积率}} $$

- 虽然累积风险不能给出终生患癌风险的估计，但当将截断的最高年龄组选择为接近该人群平均预期寿命的年龄时，它可被用作该风险的近似值。


## 当前概率法- Current probability

> **当前概率**通过估计**假想出生队列**在其一生中可能发生的癌症数量，可以得到较为现实的终生患癌风险的估计。^[Esteve 等（1994）将这种方法称为“当前概率”（current probability）]

:::{layout-ncol=2}

$$
p = \frac{1}{\ell_0} \sum_{x=1}^{g} L_x t_x
$$

- $p$ 发生某癌的概率
- $t_x$ 年龄组x的发病率

:::

- $L_x$ 是在假设仅受一般人群死亡率影响的情况下，年龄为 x 的幸存者在从 x 开始的年龄区间内所生存的年数。
- $\ell_0$ 是所考虑的第一个年龄区间开始时该人群的规模。




## 当前概率法- Current probability

> 当用于常规发病数据时须基于如下两种假设

- 发病率的分母基于从未患过癌症的个体；
- 另一方面，分子只统计首次癌症病例。


## DevCan 方法

> SEER 分析程序对当前概率方法的分母进行了调整。

- 软件下载 [https://surveillance.cancer.gov/devcan/download](https://surveillance.cancer.gov/devcan/download)
- 其方法与当前概率方法的区别仅在于对 5 年年龄组数据的处理方式
- DevCan 假定仅有每位个体的首发原发肿瘤数据可用

## AMP 方法

> AMP方法^[多原发癌校正方法，Adjusted for Multiple Primaries]可以解决以下问题：对于登记处无法精确识别同一人群中多个原发肿瘤的情况，或在个体数据不可获得的情况下，该方法能够进行处理。

### 适用情况{-}

- 肿瘤登记数据的多原发癌症无法被精确识别
- 肿瘤登记数据个体癌症病例数据不可获得

## AMP 方法

$$
S =
\sum_{i=1}^{f} \frac{R_i}{R_i + M_i - D_i} \hat{S}^*_0(a_i)
\times \left\{ 1 - \exp \left( \frac{-w_i}{N_i} (R_i + M_i - D_i) \right) \right\}
$$

- S 表示被诊断为癌症的概率；
- $M_i$ 表示年度死亡人数（全因死亡）；
- $D_i$ 表示年度癌症死亡人数（癌症死亡）；
- $R_i$ 表示年度（登记的）癌症病例数；
- $N_i$ 表示年中人口规模；
- $w_i$ 表示第 i 个年龄组的宽度；
- $\hat{S}^*_0(a_i)$ 表示在年龄 a_i 时仍然存活且无癌的概率。


## AMP 方法

### AMP 方法的假设条件{-}

- 无癌个体的非癌症死亡率与总体人群相同；
- 从未患过癌症的个体，其（新）患癌风险与总体人群相同；
- 如果从未患过癌症，则不可能死于癌症；
- 癌症患者再次患癌的风险与从未患过癌症的人相同；
- 癌症患者与从未患过癌症者死于其他原因（非癌症）的概率相同。

## 风险的统计学检验


# R包 ltRISK
## 安装R语言环境

- [下载并安装最新版本的R(Rhttps://cloud.r-project.org)](https://cloud.r-project.org)
- [下载并安装最新版本的Rstudio(https://posit.co/download/rstudio-desktop/)](https://posit.co/download/rstudio-desktop/)


## 安装ltRISK^[我们编写了R语言包ltRISK实现AMP方法估计终生患癌风险]

**从github仓库安装ltRISK包**

```{r}
#| echo: true
#| eval: false
install.packages("remotes")
remotes::install_github("gigu003/ltRISK")
```

**使用本地安装包安装** ltRISK_0.1.0.tar.gz

```{r}
#| echo: true
#| eval: false
#| code-line-numbers: true
install.packages("remotes")
remotes::install_local("ltRISK_0.1.0.tar.gz")
```

**加载ltRISK包**

```{r}
library("ltRISK")
```

## 计算累积率和累积风险

> `cumurate()`函数和`cumrisk()`函数分别用于计算累积率和风险

准备数据：*人口数*和*发病数*，或直接准备*年龄别率*

```{r}
# 19个年龄组人口数
pop <- c(20005, 86920, 102502, 151494, 182932, 203107, 240289, 247076, 199665,163820, 145382, 86789, 69368, 51207, 39112, 20509, 12301, 6586, 1909)

# 19个年龄组发病数
inci <- c(156, 58, 47, 49, 48, 68, 120, 162, 160, 294, 417, 522, 546, 628, 891, 831, 926, 731, 269)

# 年龄别率
mx <- inci / pop
```

## 计算累积率和累积风险

```{r}
# 计算0-74岁累积率
r1 <- cumrate(mx, eage = 70)
r1

# 计算0-69岁累积率
r2 <- cumrate(mx, eage = 65)
r2
```

## 计算累积率和累积风险

```{r}
# 将累积率转换为累积风险
cumrisk(r1, mp = 100, decimal = 2)
cumrisk(r2, mp = 100, decimal = 2)
```


## 使用AMP方法估计终生患癌风险
### 变量和数据格式{-}

> 分年龄组（5岁组）**癌症发病数(ri)**、**癌症死亡数(di)**、**全因死亡数(mi)**和**人口数(ni)**，以及其它分层变量。

```{r}
#| echo: false
ni <- c(73872987, 82029530, 72267070, 78303514, 99425613, 119915673, 98068725, 96644427, 121225951, 121250720, 96012917, 79863455, 75972753, 52929797, 37551107, 29047207, 19584254, 13854299)
mi <- c(60594, 17718, 18883, 28127, 37493, 75223, 83574, 100655, 211467, 278913, 419663, 445223, 770865, 929008, 1058922, 1346942, 1576852, 2305312)
di <- c(3511, 2801, 2553, 3183, 4960, 9456, 13509, 23935, 62386, 111640, 147866,203955, 301892, 304985, 302785, 323804, 275557, 197614)
ri <- c(9303, 6887, 6248, 8509, 16961, 39439, 56670, 86535, 189251, 289320, 344395, 411232, 552071, 491213, 433786, 395544, 292672, 173503)
agegrp <- as.integer(c(0, seq(5, 85, 5)))
data <- data.frame(agegrp=agegrp, ri=ri, di=di, mi=mi, ni=ni)
head(data)
```

## 使用AMP方法估计终生患癌风险

> **ltr** 函数可以估计终生风险，返回结果是一个包含三个元素的列表，包括年龄组、**年龄条件概率(si)**和**各年龄组方差(vari)**。

```r
# mi	各年龄组年度全因死亡数
# di	各年龄组年度癌症死亡数
# ri	各年龄组年度癌症诊断数
# ni	各年龄组年度风险人口数
# age_width	年龄组组距
# type	字符型，值为 "developing" or "dying" 表示估计发病风险或死亡风险。

ltr(mi, di, ri, ni, age_width = 5, type = "developing")
```

## 使用AMP方法估计终生患癌风险

```{r}
ll <- ltr(data$mi, data$di, data$ri, data$ni)
names(ll)
ll$si
```

## 点估计和可信区间
> **estimate** 函数计算终生风险的点估计值和95%可信区间，当指定起始年龄时，则假定在那个年龄是未患癌且存活，所以估计值为起始年龄至死亡的患癌风险。

**estimate**函数的参数：

- x	'ltr'对象，由**ltr**函数生成
- sage	起始年龄

使用方法：

```r
estimate(x, sage = 0, mp = 100, decimal = 2)
```


## 点估计和可信区间
> *post_ci*函数把点估计值和可信区间包裹起来。

```{r}
s <- estimate(ll)
post_ci(s)
s1 <- estimate(ll, sage = 40)
post_ci(s1)
```

## 点估计和可信区间
```{r}
s2 <- estimate(ll, sage = 50)
post_ci(s2)
s3 <- estimate(ll, sage = 60)
post_ci(s3)
s4 <- estimate(ll, sage = 70)
post_ci(s4)
```


# 基于Global Cancer Observatory数据估计患癌风险
## ltRISK包内置数据集**GCO_Today**

> ltRISK内置了一个数据集(**GCO_Today**)包含2022年全球癌症发病数、死亡数、全因死亡数、和2022年人口数^[数据来源：Global Cancer Observatory Today, and the World Population Prospects 2022]。

```{r}
# 加载GCO_Today数据集
data(GCO_Today)

# 显示TCO_Today数据集变量名
names(GCO_Today)
```

## ltRISK包内置数据集**GCO_Today**

```{r}
head(GCO_Today)
# Use ?GCO_Today to see the detailed description of GCO_Today dataset.
?GCO_Today
```

## ltRISK包内置数据集**GCO_Today**
> **GCO_Today**是一个包含40,824行和8个变量的数据框，如使用，请引用。

```{r}
#| echo: false
#| label: tbl-gco
#| tbl-cap: GCO_Today 示例数据集变量介绍 
library(flextable)
data <-data.frame(
  stringsAsFactors = FALSE,
              name = c("region","cancers","sex",
                       "age","inci","mort","death","pop"),
              type = c("Character","Integer",
                       "Integer","Integer","Integer","Integer","Integer","Integer"),
       description = c("The regions are classified into 20 geographic areas as defined by the United Nations Population Division.",
                       "Cancers include the code of cancer sites which is the same as cancer dictionary in the GLOBOCAN database.",
                       "Sex code, 1 for male, 2 for female, 3 for total.",
                       "The ages are grouped into 5-year intervals, where 0, 1, 2, 3, …, 17 represent the 0-4, 5-9, 10-14, 15-19, …, and 85+ age groups, respectively.",
                       "Number of (registered) cancer cases.",
                       "Number of cancer deaths (cancer mortality).","Number of deaths (all-cause mortality).",
                       "The size of the mid-year population.")
)

header <- data.frame(
  col_keys = colnames(data),
  first =  c("Variable name", "Type", "Description"))
tt <- data |> flextable() |>
  set_header_df(mapping = header, key = "col_keys" ) |> 
  width(j=1,width = 1.2) |> 
  width(j=2,width = 1) |> 
  width(j=3,width = 8) |> 
  theme_zebra(odd_body = "lightblue",odd_header = "gray90")
tt
```

## 估计年龄条件概率

```{r}
#| echo: true
library(ltRISK)
library(dplyr)
data(GCO_Today)
data <- GCO_Today |> 
  filter(region == "World", cancers == 39) |>
  mutate(sex = factor(sex, levels= c(1, 2, 3), labels = c("Male", "Female", "Total"))) |> 
  group_by(sex)
model <- data |> 
  reframe(model_develop = list(ltr(death, mort, inci, pop, type = "developing")),
          model_dying = list(ltr(death, mort, inci, pop, type = "dying"))
          )
```

## 估计年龄条件概率

```{r}
model$model_develop[[1]]
```

## 估计终生患癌风险
### 代码和结果{-}

```{r}
res <- model |>   
  mutate(lr_developing = post_ci(estimate(model_develop)),
         lr_dying = post_ci(estimate(model_dying)))
res
```


## 估计从年龄X至死亡的患癌风险

```{r}
#| echo: true
#| source-line-numbers: "1,4"
#| class-output: "highlight numberLines"
#| output-line-numbers: "2"
res <- model |>   
  mutate(lr_deve_40 = post_ci(estimate(model_develop, sage = 40)),
         lr_deve_50 = post_ci(estimate(model_develop, sage = 50)),
         lr_deve_60 = post_ci(estimate(model_develop, sage = 60)),
         lr_deve_70 = post_ci(estimate(model_develop, sage = 70)),
         lr_deve_80 = post_ci(estimate(model_develop, sage = 80))
         ) |> 
  select(-model_develop, -model_dying)
res
```

# 全球和不同地区终生患癌风险
## 终生患癌风险
### 代码和结果

```{r}
data(GCO_Today)
data <- GCO_Today |> 
  filter(cancers == 39) |>
  mutate(sex = factor(sex, levels= c(1, 2, 3), labels = c("Male", "Female", "Total"))) |> 
  group_by(region, sex)
model <- data |> 
  reframe(model_develop = list(ltr(death, mort, inci, pop, type = "developing")),
          model_dying = list(ltr(death, mort, inci, pop, type = "dying")))
```

## 终生患癌风险
### 代码和结果

```{r}
res1 <- model |>  
  mutate(ltr1 = post_ci(estimate(model_develop)),
         ltr2 = post_ci(estimate(model_develop, sage = 40)),
         ltr3 = post_ci(estimate(model_develop, sage = 50)),
         ltr4 = post_ci(estimate(model_develop, sage = 60)),
         ltr5 = post_ci(estimate(model_develop, sage = 70)),
         ltr6 = post_ci(estimate(model_develop, sage = 80))) |> 
  select(-model_develop, -model_dying)
```


## 终生患癌风险
> @tbl-lr1 展示了不同性别人群终生患癌风险。

```{r}
#| label: tbl-lr1
#| tbl-cap: 全球不同性别人群终生患癌风险
res1 |> 
  filter(region == "World") |> 
  select(-region) |> 
  flextable() |> 
  set_header_labels(values = c("Sex", "Birth-death", "40-death",
                               "50-death", "60-death", "70-death",
                               "80-death")) |>
  width(j = 2:7, width = 1.5) |> 
  fontsize(size = 14) |> 
  theme_apa()
```

## 终生患癌风险
> @tbl-lr2 展示了全球不同地区人群终生患癌风险。

```{r}
#| label: tbl-lr2
#| tbl-cap: 全球不同地区人群终生患癌风险
res1 |> 
  filter(!region == "World", sex == "Total") |> 
  select(-sex) |> 
  flextable() |> 
  set_header_labels(values = c("Sex", "Birth-death", "40-death",
                               "50-death", "60-death", "70-death",
                               "80-death")) |>
  width(j = 2:7, width = 1.25) |> 
  width(j = 1, width = 2) |> 
  theme_report()
```

## 全球终生癌症死亡风险 

```{r}
#| echo: true
res2 <- model |>  
  mutate(ltr1 = post_ci(estimate(model_dying)),
         ltr2 = post_ci(estimate(model_dying, sage = 40)),
         ltr3 = post_ci(estimate(model_dying, sage = 50)),
         ltr4 = post_ci(estimate(model_dying, sage = 60)),
         ltr5 = post_ci(estimate(model_dying, sage = 70)),
         ltr6 = post_ci(estimate(model_dying, sage = 80))) |> 
  select(-model_develop, -model_dying)
```

## 全球终生癌症死亡风险 

> @tbl-lr3 展示了不同性别人群全球终生癌症死亡风险。

```{r}
#| label: tbl-lr3
#| tbl-cap: 全球终生癌症死亡风险
res2 |> 
  filter(region == "World") |> 
  select(-region) |> 
  flextable() |> 
  set_header_labels(values = c("Sex", "Birth-death", "40-death",
                               "50-death", "60-death", "70-death",
                               "80-death")) |>
  width(j = 2:7, width = 1.5) |> 
  theme_apa()
```

## 全球终生癌症死亡风险
> @tbl-lr4 展示了全球不同地区人群终生癌症死亡风险。

```{r}
#| label: tbl-lr4
#| tbl-cap: 全球不同地区人群终生癌症死亡风险
res2 |> 
  filter(!region == "World", sex == "Total") |> 
  select(-sex) |>
  #head(n=15) |> 
  flextable() |> 
  set_header_labels(values = c("Sex", "Birth-death", "40-death",
                               "50-death", "60-death", "70-death",
                               "80-death")) |>
  width(j = 2:7, width = 1.25) |> 
  width(j = 1, width = 2) |> 
  theme_report()
```


